## 2022.02 Week2 TIL

### [Network/WEB] SSL offloading

https://aws-hyoh.tistory.com/entry/AWS-Application-Load-Balancer-%EC%89%BD%EA%B2%8C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0

https://minholee93.tistory.com/entry/SSL-offloading-%EC%9D%B4%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C



SSL을 통해서 암호화 통신을 하기 위해서는 SSL handshaking이 불가피하다.

근데 이 handshaking이 자원 소모가 생각보다 많다. (SSL handshaking은 따로 정리)

따라서 SSL HandShaking을 API 서버가 직접하면 서버에 부하가 가중된다.



그래서 대부분 API 서버들 앞단에 프록시 서버를 두고 해당 프록시 서버에 SSL 관련 작업을 위임한다. 

이러한 작업을 SSL offloading 이라고 한다.



![img](D:/til/img.png)



- 프록시 서버를 거친 데이터는 복호화되어서 HTTP 통신을 하므로 HTTPS 통신보다 빠르다.
- 대신 프록시 서버와 내부 서버간의 보안에 각별한 신경을 써야 한다. (방화벽 등)





### [WEB] WebHook

하나의 웹 또는 앱이 다른 어플리케이션으로 이벤트 정보를 실시간으로 제공하기 위한 방법.

> "A webhook in web development is a method of augmenting or altering the behavior of a web page or web application with custom callback" 
>
> 출처 : 위키피디아

일반적인 API(Polling)은 클라이언트가 서버를 호출하는 방식이다. 

하지만 웹훅은 서버에서 특정 이벤트 발생 시 클라이언트를 호출하는 방식이다. "리버스 API"라고도 부른다.



#### Polling Madness

클라이언트가 서버의 정보를 얻기 위해 API를 지속적으로 호출하는 방식 -> 비효율적이고 낭비가 심함.

참고 : https://leffept.tistory.com/329



### [Linux] stress 툴

- linux 부하 테스트를 위한 툴, 오토스케일링이 잘 되는지 테스트할 때 사용할 수 있다.
- rand()를 통한 임의 숫자에 대해 sqrt() 연산 반복 수행 -> CPU 부하 테스트
- 메모리 버퍼를 디스크에 쓰는 sync() 시스템 콜을 통한 I/O 테스트
- malloc(), free() 를 통한 메모리 부하 테스트
- mkstemp()를 통한 디스크 부하 테스트



사용예제)

**3G 크기 파일을 디스크에 쓰고 지우기 1분 연속 수행**

```bash
$ stress --hdd 1 -hdd-bytes 3G -v --timeout 1m
```

**3G 크기 파일을 디스크에 쓰고 보관하는 작업 1분 연속 수행**

```bash
$ stress --hdd 1 --hdd-noclean --hdd-bytes 3G -v --timeout 1m
```

**8개 프로세스로 CPU 부하 테스트, 4개 프로세스로 I/O 테스트, 2개 프로세스로 메모리 테스트(128M 씩 할당후 해제) 10초간 수행**

```bash
$ stress --cpu 8 --io 4 --vm 2 --vm-bytes 128M --timeout 10s -v
```

### [Linux] lsof

- lsof는 list open files의 약자로 시스템에서 열린 파일 목록을 매우 상세하게 보여줌.
  - 프로세스 ID, 디바이스 정보, FD 등등

- Linux와 Unix는 추상화된 파일 시스템(VFS)을 사용하므로 일반 파일, 디렉터리, 네트워크 소켓, 라이브러리, 심볼링 링크 도 모두 파일로 처리됨. -> lsof 로 모두 확인 가능함.

> root로 실행한 프로그램 정보는 root로 해당 명령어 실행해야만 보인다. 당연한건데 이것때문에 약간 뻘짓했음.

### lsof 관련해서 겪은 이슈

codedeploy로 배포하는데 서버에 직접들어가서 root로 스프링 올리놓고, 기능 새로 추가한다음 배포하려니 안됐던 이슈

-> appspec.yml은 스크립트를 ec2-user 권한으로 실행하도록 했음.

```bash
#!/bin/bash
APPLICATION_PORT=8080
CURRENT_PID="$(lsof -t -i :${APPLICATION_PORT} -s TCP:LISTEN)";

if [ -z ${CURRENT_PID} ]; then
  echo "> Port Number: ${APPLICATION_PORT}";
  echo "> There is no running application";
else
  kill -9 ${CURRENT_PID};
  echo "Port Number: ${APPLICATION_PORT}";
  echo "${CURRENT_PID} process kill complete";
  sleep 5
fi

```

lsof 명령어로 8080 포트로 서비스 중인 프로세스 ID를 찾아야되는데 root로 실행중이라서 ec2-user로 해당 명령어 실행하면 안나옴.

그래서 스프링을 안죽이고 그냥 실행하려니 톰캣 올라갈때 8080포트 이미 사용중이라서 오류가 발생함.

-> 스프링 종료해서 웹 앱이 꺼진상태로 다시 배포해서 해결.



### [Database] Aquerytool

- 직관적이고 효율적으로 ERD를 설계할 수 있는 웹 기반 ERD 툴
- UI가 마음에 든다. 나중에 사용해봐야지


### [Middelware] Embedded Tomcat vs Tomcat

Spring boot의 경우 tomcat이 내장되어 있어서 따로 외부 tomcat을 구성하지 않아도 어플리케이션을 빌드하는 것만으로도 웹앱을 서비스 할 수 있다.


**내장 톰캣**
- build된 스프링부트 애플리케이션 jar(또는 war)를 java 명령어로 실행

**외장 톰캣**
- tomcat 설치 및 구성
- tomcat 설정(server.xml)을 통해 지정한 appBase(default는 webapp)의 경로에 스프링 애플리케이션에서 export한 war파일을 위치 시킨다.
- tomcat을 실행한다.

https://thxwelchs.github.io/EmbeddedTomcat%EA%B3%BCTomcat%EC%9D%98%EC%B0%A8%EC%9D%B4/



t2.micro 타입 ec2 인스턴스를 Autoscaling을 이용해서 ap-northeast-2a, ap-northeast-2b, ap-northeast-2c, ap-northeast-2d의 4개 AZ에 생성하려하니 아래와 같이 에러가 발생.

![image-20220215135210201](C:/Users/83658/Desktop/gitlab/TIL/docs/til/image-20220215135210201.png)

인스턴스 타입에 따라 지원되는 가용영역을 아래 방법으로 파악가능.

https://blog.voidmainvoid.net/390


codedeploy 배포시 allowtraffic에 시간이 오래 걸리는 이유
https://stackoverflow.com/questions/58162027/why-does-aws-codedeploy-allowtraffic-take-3-minutes-per-instance
https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-target-groups.html#deregistration-delay
어느 설정 바꾸면 조금 덜 걸리는지 확인(아마도 로드밸런서랑 오토스케일링 그룹 설정에 있었떤거같은데 기억이 안남.)

### [Etc] Jar와 War


https://ifuwanna.tistory.com/224