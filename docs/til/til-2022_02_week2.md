## 2022.02 Week2 TIL

### [Network/WEB] SSL offloading

https://aws-hyoh.tistory.com/entry/AWS-Application-Load-Balancer-%EC%89%BD%EA%B2%8C-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0

https://minholee93.tistory.com/entry/SSL-offloading-%EC%9D%B4%EB%9E%80-%EB%AC%B4%EC%97%87%EC%9D%BC%EA%B9%8C



SSL을 통해서 암호화 통신을 하기 위해서는 SSL handshaking이 불가피하다.

근데 이 handshaking이 자원 소모가 생각보다 많다. (SSL handshaking은 따로 정리)

따라서 SSL HandShaking을 API 서버가 직접하면 서버에 부하가 가중된다.



그래서 대부분 API 서버들 앞단에 프록시 서버를 두고 해당 프록시 서버에 SSL 관련 작업을 위임한다. 

이러한 작업을 SSL offloading 이라고 한다.



![img](D:/til/img.png)



- 프록시 서버를 거친 데이터는 복호화되어서 HTTP 통신을 하므로 HTTPS 통신보다 빠르다.
- 대신 프록시 서버와 내부 서버간의 보안에 각별한 신경을 써야 한다. (방화벽 등)





### [WEB] WebHook

하나의 웹 또는 앱이 다른 어플리케이션으로 이벤트 정보를 실시간으로 제공하기 위한 방법.

> "A webhook in web development is a method of augmenting or altering the behavior of a web page or web application with custom callback" 
>
> 출처 : 위키피디아

일반적인 API(Polling)은 클라이언트가 서버를 호출하는 방식이다. 

하지만 웹훅은 서버에서 특정 이벤트 발생 시 클라이언트를 호출하는 방식이다. "리버스 API"라고도 부른다.



#### Polling Madness

클라이언트가 서버의 정보를 얻기 위해 API를 지속적으로 호출하는 방식 -> 비효율적이고 낭비가 심함.

참고 : https://leffept.tistory.com/329



### [Linux] stress 툴

- linux 부하 테스트를 위한 툴, 오토스케일링이 잘 되는지 테스트할 때 사용할 수 있다.
- rand()를 통한 임의 숫자에 대해 sqrt() 연산 반복 수행 -> CPU 부하 테스트
- 메모리 버퍼를 디스크에 쓰는 sync() 시스템 콜을 통한 I/O 테스트
- malloc(), free() 를 통한 메모리 부하 테스트
- mkstemp()를 통한 디스크 부하 테스트



사용예제)

**3G 크기 파일을 디스크에 쓰고 지우기 1분 연속 수행**

```bash
$ stress --hdd 1 -hdd-bytes 3G -v --timeout 1m
```

**3G 크기 파일을 디스크에 쓰고 보관하는 작업 1분 연속 수행**

```bash
$ stress --hdd 1 --hdd-noclean --hdd-bytes 3G -v --timeout 1m
```

**8개 프로세스로 CPU 부하 테스트, 4개 프로세스로 I/O 테스트, 2개 프로세스로 메모리 테스트(128M 씩 할당후 해제) 10초간 수행**

```bash
$ stress --cpu 8 --io 4 --vm 2 --vm-bytes 128M --timeout 10s -v
```

### [Linux] lsof

- lsof는 list open files의 약자로 시스템에서 열린 파일 목록을 매우 상세하게 보여줌.
  - 프로세스 ID, 디바이스 정보, FD 등등

- Linux와 Unix는 추상화된 파일 시스템(VFS)을 사용하므로 일반 파일, 디렉터리, 네트워크 소켓, 라이브러리, 심볼링 링크 도 모두 파일로 처리됨. -> lsof 로 모두 확인 가능함.

> root로 실행한 프로그램 정보는 root로 해당 명령어 실행해야만 보인다. 당연한건데 이것때문에 약간 뻘짓했음.

### lsof 관련해서 겪은 이슈

codedeploy로 배포하는데 서버에 직접들어가서 root로 스프링 올리놓고, 기능 새로 추가한다음 배포하려니 안됐던 이슈

-> appspec.yml은 스크립트를 ec2-user 권한으로 실행하도록 했음.

```bash
#!/bin/bash
APPLICATION_PORT=8080
CURRENT_PID="$(lsof -t -i :${APPLICATION_PORT} -s TCP:LISTEN)";

if [ -z ${CURRENT_PID} ]; then
  echo "> Port Number: ${APPLICATION_PORT}";
  echo "> There is no running application";
else
  kill -9 ${CURRENT_PID};
  echo "Port Number: ${APPLICATION_PORT}";
  echo "${CURRENT_PID} process kill complete";
  sleep 5
fi

```

lsof 명령어로 8080 포트로 서비스 중인 프로세스 ID를 찾아야되는데 root로 실행중이라서 ec2-user로 해당 명령어 실행하면 안나옴.

그래서 스프링을 안죽이고 그냥 실행하려니 톰캣 올라갈때 8080포트 이미 사용중이라서 오류가 발생함.

-> 스프링 종료해서 웹 앱이 꺼진상태로 다시 배포해서 해결.



### [Database] Aquerytool

- 직관적이고 효율적으로 ERD를 설계할 수 있는 웹 기반 ERD 툴
- UI가 마음에 든다. 나중에 사용해봐야지


### [Middelware] Embedded Tomcat vs Tomcat

Spring boot의 경우 tomcat이 내장되어 있어서 따로 외부 tomcat을 구성하지 않아도 어플리케이션을 빌드하는 것만으로도 웹앱을 서비스 할 수 있다.


**내장 톰캣의 스프링 애플리케이션 실행**
- build된 스프링부트 애플리케이션 jar(또는 war)를 java 명령어로 실행

**외장 톰캣의 스프링 애플리케이션 실행**
- tomcat 설치 및 구성
- tomcat 설정(server.xml)을 통해 지정한 appBase(default는 webapp)의 경로에 스프링 애플리케이션에서 export한 war파일을 위치 시킨다.
- tomcat을 실행한다.

**내장 톰캣과 외장 톰캣의  차이**
1. 내장 톰캣
- 내장 톰캣으로 실행되는 스프링부트 어플리케이션은 1개의 프로그램 처럼 동작해서 포트를 독자적으로 점유함 -> 호스트 분기 기능 사용이 힘듦
  - 물론 서블릿컨테이너팩토리 빈을 재구성해서 multiple context를 등록하는 방식으로도 되기는 함. 근데 굳이..? 그냥 앞단에 nginx 같은 웹서버로 reverse proxy 구성하면 됨.
- 내장 톰캣은 톰캣 구성에 대한 부분을 분리해서 개발자들이 코드 작성에 더 집중하도록 함. 필요하면 application.properties에 설정하면됨.
2. 외장 톰캣
- Virtual Host를 설정해서 여러 어플리케이션을 하나의 포트로 서비스 할 수 있다.
참고 : https://thxwelchs.github.io/EmbeddedTomcat%EA%B3%BCTomcat%EC%9D%98%EC%B0%A8%EC%9D%B4/


### [AWS] t2.micro 타입 인스턴스를 서울리전에 배포할 때 발생한 에러 
t2.micro 타입 ec2 인스턴스를 Autoscaling을 이용해서 ap-northeast-2a, ap-northeast-2b, ap-northeast-2c, ap-northeast-2d의 4개 AZ에 생성하려하니 아래와 같이 에러가 발생.

![image-20220215135210201](C:/Users/83658/Desktop/gitlab/TIL/docs/til/image-20220215135210201.png)

> 참고) 인스턴스 타입에 따라 지원되는 가용영역을 아래 방법으로 파악가능하다.   
> https://blog.voidmainvoid.net/390




### [AWS] CodeDeploy AllowTraffic

- codedeploy 배포시 allowtraffic에 시간이 오래 걸리는 이유

https://stackoverflow.com/questions/58162027/why-does-aws-codedeploy-allowtraffic-take-3-minutes-per-instance
https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-target-groups.html#deregistration-delay  
- 요약 : 로드밸런서에서 트래픽을 block하고 allow할때 target registration/deregistration을 하는데 이때 헬스체크 등 시간이 많이 소요됨. LB 설정에 따라 다르겠지만..


- failover를 위해 여러 대의 인스턴스에 배포한다면 코드디플로이 배포 설정에서 AllAtOnce 나 HalfAtOnce로 하면 OneAtTime 보다는 빠르게 진행됨.
  - AllAtOnce는 대상 인스턴스에 한꺼번에 배포하는거고 HalfAtOnce는 절반먼저하고 나머지 절반에 배포, OneAtTime은 인스턴스 1대씩 배포(제일 느림)
  - 2대 인스턴스에 대해서 블루그린 배포 해보니 One At a Time일때 12분 정도 소요되었고, AllAtOnce 배포하니 5분정도 소요됨.(설정이나 배포하는 방식 등에 따라 다를 수 있음)

### [Java/Web] Jar와 War
- JAR(Java ARchive)
  - class와 같은 java 리소스와 속성 파일, 라이브러리 등의 파일이 포함되어있다. 
  - Java 프로젝트를 압축한 파일이라고 보면 된다.
  - 원하는 구조로 구성이 가능하며 JDK(Java Development Kit)에 포함된 JRE(Java Runtime Environment)만 가지고도 실행이 가능하다. (이미 빌드된 상태이므로 당연한것)

- WAR(Web Application aRchive)
  - servlet / jsp 컨테이너에 배치 할 수 있는 웹 어플리케이션 압축 파일 포맷이다.
  - Servlet Context 관련 파일들로 패키징 되어있다.
  - 웹 관련 자원만 포함되어있다.
  - Jar와 달리 사전 정의된 구조를 사용한다.
  - 실행을 위해선 Tomcat과 같은 Web Application Server가 필요하다.
WAR도 JAR의 일종이라고 생각하면 됨.

https://ifuwanna.tistory.com/224

### [GitLab] Container Registry


https://docs.gitlab.com/ee/user/packages/container_registry/

### [Python]Underscore(_), Double Underscore(__)
- Case1. 언더스코어(_) 혼자 쓰이는 경우
인터프리터에서 마지막 실행 결과 값을 가지는 변수로 사용됨.

- Case2. 변수로 사용될 경우
변수 값을 굳이 쓸 필요 없을 때
```python
for _ in range(5):
  print(_)
```

- Case3. __이름__
내장 된 특수 함수 또는 변수를 의미한다.
ex) 생성자 __init__ 

- Case4. Naming
파이썬은 접근 제한 속성을 강제하지 않음.
  - 변수_ : 예약어를 변수명으로 사용할 수 없을 때.
  - _함수 : 앞에 underscore가 붙은 함수는 export 되지 않는다. (private과 비슷한 역할을 해줌. but, import 문에서는 누락되지만 직접 호출은 가능하다.
  - __변수 : Mangling. 선언된 클래스 안에서만 해당 이름으로 가능하다.

https://ebbnflow.tistory.com/255

### [Python] Name Mangling

### [DevOps] Chatops

### [WEB] HTTP 1.1 vs HTTP 2 

### [Slack] slack 메시지 꾸미기 
https://blog.voidmainvoid.net/221

### [Linux] Shell 문자열 다루기

https://wiki.kldp.org/HOWTO/html/Adv-Bash-Scr-HOWTO/string-manipulation.html


### [OS] Thread-Safe


### [ETC] multipart encoding
helper method
deflate, gzip, brotli encoding
SOCKS
Test Coverage

jq -r : raw-output